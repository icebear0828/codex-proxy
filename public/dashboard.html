<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Codex Proxy - Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #111827;
      min-height: 100vh;
    }

    /* Top Nav */
    .topnav {
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 0 2rem;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .topnav-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .topnav-logo {
      width: 28px;
      height: 28px;
      background: #e5e7eb;
      border-radius: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .topnav-logo svg {
      width: 16px;
      height: 16px;
      color: #6b7280;
    }
    .topnav-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #111827;
    }
    .topnav-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .badge-online {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: #ecfdf5;
      color: #10a37f;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .badge-online .dot {
      width: 7px;
      height: 7px;
      background: #10a37f;
      border-radius: 50%;
    }
    .btn-add {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 6px 14px;
      background: #10a37f;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 0.78rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-add:hover { background: #0e8f6e; }
    .btn-add:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Main content */
    .main {
      max-width: 960px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Section headings */
    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.75rem;
    }

    /* Accounts */
    .accounts-grid {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }
    .account-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem;
      min-width: 260px;
      flex: 1;
      position: relative;
    }
    .account-top {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 600;
      color: #fff;
      flex-shrink: 0;
    }
    .avatar-purple { background: #8b5cf6; }
    .avatar-amber { background: #f59e0b; }
    .avatar-blue { background: #3b82f6; }
    .avatar-green { background: #10a37f; }
    .avatar-red { background: #ef4444; }
    .account-info { flex: 1; min-width: 0; }
    .account-email {
      font-size: 0.82rem;
      font-weight: 600;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .account-plan {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .status-badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-ok { background: #ecfdf5; color: #10a37f; }
    .status-expired { background: #fef2f2; color: #ef4444; }
    .status-rate-limited { background: #fffbeb; color: #d97706; }
    .status-refreshing { background: #eff6ff; color: #3b82f6; }
    .status-disabled { background: #f3f4f6; color: #6b7280; }
    .account-stats {
      display: flex;
      gap: 1.5rem;
    }
    .stat {
      display: flex;
      flex-direction: column;
    }
    .stat-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .stat-value {
      font-size: 0.85rem;
      font-weight: 600;
      color: #111827;
    }
    .btn-delete-account {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 4px 10px;
      background: #fff;
      border: 1px solid #fca5a5;
      border-radius: 6px;
      color: #ef4444;
      font-size: 0.7rem;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-delete-account:hover { background: #ef4444; color: #fff; }
    .empty-state {
      text-align: center;
      color: #9ca3af;
      padding: 2rem;
      font-size: 0.9rem;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 2rem;
    }

    /* Add account modal area */
    .add-section {
      display: none;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 2rem;
    }
    .add-section.open { display: block; }
    .add-section .hint {
      font-size: 0.82rem;
      color: #6b7280;
      margin-bottom: 0.75rem;
      line-height: 1.5;
    }
    .add-section .input-row {
      display: flex;
      gap: 0.5rem;
    }
    .add-section input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.85rem;
      font-family: inherit;
      color: #111827;
      outline: none;
    }
    .add-section input::placeholder { color: #9ca3af; }
    .add-section input:focus { border-color: #10a37f; }
    .btn-submit-add {
      padding: 10px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
      color: #111827;
      font-size: 0.85rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-submit-add:hover { background: #f9fafb; }
    .btn-submit-add:disabled { opacity: 0.5; cursor: not-allowed; }
    .add-info {
      color: #10a37f;
      font-size: 0.8rem;
      margin-top: 0.5rem;
      display: none;
    }
    .add-error {
      color: #ef4444;
      font-size: 0.8rem;
      margin-top: 0.5rem;
      display: none;
    }

    /* API Configuration */
    .config-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .config-card .card-subtitle {
      font-size: 0.78rem;
      color: #6b7280;
      margin-bottom: 1.25rem;
    }
    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .config-field label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      color: #6b7280;
      margin-bottom: 0.35rem;
    }
    .config-value {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .config-value .val {
      flex: 1;
      padding: 7px 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-family: 'SF Mono', 'Consolas', monospace;
      font-size: 0.78rem;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .config-value .val-muted {
      color: #6b7280;
      font-size: 0.8rem;
    }
    .btn-copy {
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      color: #6b7280;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      transition: all 0.2s;
    }
    .btn-copy:hover { background: #e5e7eb; }
    .btn-copy.copied { background: #ecfdf5; border-color: #10a37f; color: #10a37f; }
    .btn-copy svg { width: 16px; height: 16px; }
    .config-full {
      grid-column: 1 / -1;
    }
    .val-input {
      background: #fff;
      outline: none;
      transition: border-color 0.2s;
    }
    .val-input:focus {
      border-color: #10a37f;
      box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
    }
    select.val-input { cursor: pointer; appearance: auto; }
    .btn-reset {
      padding: 7px 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      color: #6b7280;
      font-size: 0.8rem;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-reset:hover { background: #e5e7eb; color: #111827; }
    .quota-section {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #f3f4f6;
    }
    .quota-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .quota-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9ca3af;
    }
    .quota-value {
      font-size: 0.75rem;
      font-weight: 500;
      color: #111827;
    }
    .quota-bar {
      width: 100%;
      height: 6px;
      background: #f3f4f6;
      border-radius: 3px;
      overflow: hidden;
    }
    .quota-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s;
    }
    .quota-bar-green { background: #10a37f; }
    .quota-bar-amber { background: #f59e0b; }
    .quota-bar-red { background: #ef4444; }
    .quota-reset {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 4px;
    }
    .quota-limit-badge {
      display: inline-block;
      padding: 1px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 500;
      background: #fef2f2;
      color: #ef4444;
    }

    /* Integration Examples */
    .examples-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 1rem;
    }
    .tab {
      padding: 6px 14px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: #6b7280;
      font-size: 0.8rem;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab:hover { color: #111827; }
    .tab.active {
      color: #111827;
      font-weight: 500;
      border-bottom-color: #10a37f;
    }
    .code-block {
      background: #1e1e1e;
      border-radius: 10px;
      padding: 1rem 1.25rem;
      font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
      color: #d4d4d4;
      overflow-x: auto;
      white-space: pre;
      position: relative;
    }
    .code-block .copy-code-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 5px 12px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 6px;
      color: #d4d4d4;
      font-size: 0.75rem;
      font-family: inherit;
      cursor: pointer;
      transition: background 0.2s;
    }
    .code-block .copy-code-btn:hover { background: rgba(255,255,255,0.2); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Footer */
    .footer {
      text-align: center;
      padding: 1rem 2rem 2rem;
      color: #9ca3af;
      font-size: 0.8rem;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }
    .spinner-dark {
      border-color: rgba(0,0,0,0.1);
      border-top-color: #10a37f;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <nav class="topnav">
    <div class="topnav-left">
      <div class="topnav-logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <path d="M8 12l2 2 4-4"/>
        </svg>
      </div>
      <span class="topnav-title">Codex Proxy</span>
    </div>
    <div class="topnav-right">
      <span class="badge-online" id="serverBadge"><span class="dot"></span> Server Online</span>
      <button class="btn-add" id="addAccountBtn" onclick="startAddAccount()">+ Add Account</button>
    </div>
  </nav>

  <div class="main">
    <!-- Add Account Section (hidden by default) -->
    <div class="add-section" id="addSection">
      <div class="hint">
        If the popup shows an error or you're on a different machine,
        copy the full callback URL and paste it below.
      </div>
      <div class="input-row">
        <input type="text" id="addCallbackInput" placeholder="Paste callback URL">
        <button class="btn-submit-add" id="addRelayBtn" onclick="submitAddRelay()">Submit</button>
      </div>
      <div class="add-info" id="addInfo"></div>
      <div class="add-error" id="addError"></div>
    </div>

    <!-- Connected Accounts -->
    <h2 class="section-title">Connected Accounts</h2>
    <div class="accounts-grid" id="accountList">
      <div class="empty-state" style="width:100%">Loading accounts...</div>
    </div>

    <!-- API Configuration -->
    <div class="config-card">
      <h2 class="section-title" style="margin-bottom:0.25rem">API Configuration</h2>
      <p class="card-subtitle">Configure your client to use these settings.</p>
      <div class="config-grid">
        <div class="config-field">
          <label>Base URL</label>
          <div class="config-value">
            <input type="text" class="val val-input" id="baseUrl" value="Loading...">
            <button class="btn-copy" onclick="copyField('baseUrl', this)" title="Copy">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            </button>
          </div>
        </div>
        <div class="config-field">
          <label>Default Model</label>
          <div class="config-value">
            <select class="val val-input" id="defaultModel">
              <option value="codex">codex</option>
            </select>
          </div>
          <div class="val-muted" style="margin-top:4px;font-size:0.75rem;color:#9ca3af">This model will be used if no specific model is requested in the API call.</div>
        </div>
        <div class="config-field config-full">
          <label>API Key</label>
          <div class="config-value">
            <input type="text" class="val val-input" id="apiKey" value="Loading...">
            <button class="btn-copy" onclick="copyField('apiKey', this)" title="Copy">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            </button>
          </div>
        </div>
      </div>
      <button class="btn-reset" onclick="resetConfigDefaults()">Reset to defaults</button>
    </div>

    <!-- Integration Examples -->
    <div class="examples-card">
      <h2 class="section-title">Integration Examples</h2>
      <div class="tabs">
        <button class="tab active" onclick="switchTab('python', this)">Python</button>
        <button class="tab" onclick="switchTab('curl', this)">cURL</button>
        <button class="tab" onclick="switchTab('node', this)">Node.js</button>
        <button class="tab" onclick="switchTab('anthropic', this)">Anthropic</button>
        <button class="tab" onclick="switchTab('gemini', this)">Gemini</button>
      </div>
      <div class="tab-content active" id="tab-python">
        <div class="code-block" id="code-python">Loading...
<button class="copy-code-btn" onclick="copyCode('code-python')">&#9112; Copy</button></div>
      </div>
      <div class="tab-content" id="tab-curl">
        <div class="code-block" id="code-curl">Loading...
<button class="copy-code-btn" onclick="copyCode('code-curl')">&#9112; Copy</button></div>
      </div>
      <div class="tab-content" id="tab-node">
        <div class="code-block" id="code-node">Loading...
<button class="copy-code-btn" onclick="copyCode('code-node')">&#9112; Copy</button></div>
      </div>
      <div class="tab-content" id="tab-anthropic">
        <div class="code-block" id="code-anthropic">Loading...
<button class="copy-code-btn" onclick="copyCode('code-anthropic')">&#9112; Copy</button></div>
      </div>
      <div class="tab-content" id="tab-gemini">
        <div class="code-block" id="code-gemini">Loading...
<button class="copy-code-btn" onclick="copyCode('code-gemini')">&#9112; Copy</button></div>
      </div>
    </div>
  </div>

  <footer class="footer">&copy; 2025 Codex Proxy. All rights reserved.</footer>

  <script>
    let authData = null;

    const avatarColors = ['avatar-purple', 'avatar-amber', 'avatar-blue', 'avatar-green', 'avatar-red'];

    window.addEventListener('message', async (event) => {
      if (event.data?.type === 'oauth-callback-success') {
        if (addPollTimer) clearInterval(addPollTimer);
        document.getElementById('addSection').classList.remove('open');
        const infoEl = document.getElementById('addInfo');
        infoEl.textContent = 'Account added successfully!';
        infoEl.style.display = 'block';
        await loadAccounts();
        await loadStatus();
      }
    });

    function statusClass(status) {
      const map = {
        active: 'status-ok',
        expired: 'status-expired',
        rate_limited: 'status-rate-limited',
        refreshing: 'status-refreshing',
        disabled: 'status-disabled',
      };
      return map[status] || 'status-disabled';
    }

    function statusLabel(status) {
      const map = {
        active: 'Active',
        expired: 'Expired',
        rate_limited: 'Rate Limited',
        refreshing: 'Refreshing',
        disabled: 'Disabled',
      };
      return map[status] || status;
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function formatNumber(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
      return String(n);
    }

    async function loadAccounts() {
      try {
        const resp = await fetch('/auth/accounts?quota=true');
        const data = await resp.json();
        const accounts = data.accounts || [];
        renderAccounts(accounts);
      } catch (err) {
        document.getElementById('accountList').innerHTML =
          '<div class="empty-state" style="width:100%">Failed to load accounts: ' + escapeHtml(err.message) + '</div>';
      }
    }

    function renderAccounts(accounts) {
      const container = document.getElementById('accountList');

      if (accounts.length === 0) {
        container.innerHTML = '<div class="empty-state" style="width:100%">No accounts connected. Click "+ Add Account" to get started.</div>';
        return;
      }

      let html = '';
      accounts.forEach((acct, i) => {
        const usage = acct.usage || {};
        const email = acct.email || 'Unknown';
        const initial = email.charAt(0).toUpperCase();
        const colorClass = avatarColors[i % avatarColors.length];
        const requests = usage.request_count ?? 0;
        const tokens = (usage.input_tokens ?? 0) + (usage.output_tokens ?? 0);

        // Build quota HTML if available
        let quotaHtml = '';
        const q = acct.quota;
        if (q && q.rate_limit) {
          const rl = q.rate_limit;
          const pct = rl.used_percent != null ? Math.round(rl.used_percent) : null;
          const barColor = pct == null ? 'quota-bar-green'
            : pct >= 90 ? 'quota-bar-red'
            : pct >= 60 ? 'quota-bar-amber'
            : 'quota-bar-green';
          const resetAt = rl.reset_at
            ? new Date(rl.reset_at * 1000).toLocaleTimeString()
            : null;

          quotaHtml = `<div class="quota-section">
            <div class="quota-header">
              <span class="quota-label">Rate Limit</span>
              ${rl.limit_reached
                ? '<span class="quota-limit-badge">Limit Reached</span>'
                : pct != null
                  ? `<span class="quota-value">${pct}% used</span>`
                  : '<span class="quota-value">OK</span>'}
            </div>
            ${pct != null ? `<div class="quota-bar"><div class="quota-bar-fill ${barColor}" style="width:${pct}%"></div></div>` : ''}
            ${resetAt ? `<div class="quota-reset">Resets at ${escapeHtml(resetAt)}</div>` : ''}
          </div>`;
        }

        html += `<div class="account-card">
          <button class="btn-delete-account" onclick="deleteAccount('${escapeHtml(acct.id)}')">Delete</button>
          <div class="account-top">
            <div class="avatar ${colorClass}">${initial}</div>
            <div class="account-info">
              <div class="account-email">${escapeHtml(email)}</div>
              <div class="account-plan">${escapeHtml(acct.planType || 'Free Tier')}</div>
            </div>
            <span class="status-badge ${statusClass(acct.status)}">${escapeHtml(statusLabel(acct.status))}</span>
          </div>
          <div class="account-stats">
            <div class="stat">
              <span class="stat-label">Requests</span>
              <span class="stat-value">${formatNumber(requests)}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Tokens</span>
              <span class="stat-value">${formatNumber(tokens)}</span>
            </div>
          </div>
          ${quotaHtml}
        </div>`;
      });
      container.innerHTML = html;
    }

    async function deleteAccount(id) {
      if (!confirm('Remove this account?')) return;
      try {
        const resp = await fetch('/auth/accounts/' + encodeURIComponent(id), { method: 'DELETE' });
        if (!resp.ok) {
          const data = await resp.json();
          alert(data.error || 'Failed to delete account.');
          return;
        }
        await loadAccounts();
        await loadStatus();
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    }

    // --- Server defaults (set once by loadStatus) ---
    let serverBaseUrl = '';
    let serverApiKey = '';

    async function loadStatus() {
      try {
        const resp = await fetch('/auth/status');
        authData = await resp.json();

        if (!authData.authenticated) {
          window.location.href = '/';
          return;
        }

        serverBaseUrl = `${window.location.origin}/v1`;
        serverApiKey = authData.proxy_api_key || 'any-string';
        document.getElementById('baseUrl').value = serverBaseUrl;
        document.getElementById('apiKey').value = serverApiKey;

        await populateModelDropdown();
        restoreOverrides();
        updateCodeExamples();
      } catch (err) {
        console.error('Status load error:', err);
      }
    }

    async function populateModelDropdown() {
      const sel = document.getElementById('defaultModel');
      try {
        const resp = await fetch('/v1/models');
        const data = await resp.json();
        const models = data.data.map(m => m.id);
        if (models.length > 0) {
          sel.innerHTML = '';
          models.forEach(id => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = id;
            sel.appendChild(opt);
          });
          const preferred = models.find(n => n.includes('5.3-codex'));
          if (preferred) sel.value = preferred;
        }
      } catch {
        sel.innerHTML = '<option value="codex">codex</option>';
      }
    }

    function updateCodeExamples() {
      const baseUrl = escapeHtml(document.getElementById('baseUrl').value);
      const apiKey = escapeHtml(document.getElementById('apiKey').value || 'any-string');
      const model = escapeHtml(document.getElementById('defaultModel').value);

      document.getElementById('code-python').innerHTML =
`from openai import OpenAI

client = OpenAI(
    base_url="${baseUrl}",
    api_key="${apiKey}",
)

response = client.chat.completions.create(
    model="${model}",
    messages=[
        {"role": "user", "content": "Explain quantum computing in simple terms"}
    ],
)

print(response.choices[0].message.content)
<button class="copy-code-btn" onclick="copyCode('code-python')">&#9112; Copy Code</button>`;

      document.getElementById('code-curl').innerHTML =
`curl ${baseUrl}/chat/completions \\
  -H "Content-Type: application/json" \\
  -H "Authorization: Bearer ${apiKey}" \\
  -d '{
    "model": "${model}",
    "messages": [
      {"role": "user", "content": "Explain quantum computing in simple terms"}
    ]
  }'
<button class="copy-code-btn" onclick="copyCode('code-curl')">&#9112; Copy Code</button>`;

      document.getElementById('code-node').innerHTML =
`import OpenAI from "openai";

const client = new OpenAI({
    baseURL: "${baseUrl}",
    apiKey: "${apiKey}",
});

const stream = await client.chat.completions.create({
    model: "${model}",
    messages: [
        { role: "user", content: "Explain quantum computing in simple terms" },
    ],
    stream: true,
});

for await (const chunk of stream) {
    process.stdout.write(chunk.choices[0]?.delta?.content || "");
}
<button class="copy-code-btn" onclick="copyCode('code-node')">&#9112; Copy</button>`;

      const messagesUrl = escapeHtml(window.location.origin + '/v1/messages');
      document.getElementById('code-anthropic').innerHTML =
`import Anthropic from "@anthropic-ai/sdk";

const client = new Anthropic({
    baseURL: "${messagesUrl.replace('/v1/messages', '/v1')}",
    apiKey: "${apiKey}",
});

const message = await client.messages.create({
    model: "claude-sonnet-4-20250514",
    max_tokens: 1024,
    messages: [
        { role: "user", content: "Explain quantum computing in simple terms" },
    ],
});

console.log(message.content[0].text);
<button class="copy-code-btn" onclick="copyCode('code-anthropic')">&#9112; Copy</button>`;

      const geminiBase = escapeHtml(window.location.origin);
      document.getElementById('code-gemini').innerHTML =
`curl ${geminiBase}/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey} \\
  -H "Content-Type: application/json" \\
  -d '{
    "contents": [
      {"role": "user", "parts": [{"text": "Explain quantum computing"}]}
    ]
  }'

# Streaming
curl ${geminiBase}/v1beta/models/gemini-2.5-pro:streamGenerateContent?alt=sse&key=${apiKey} \\
  -H "Content-Type: application/json" \\
  -d '{
    "contents": [
      {"role": "user", "parts": [{"text": "Explain quantum computing"}]}
    ]
  }'
<button class="copy-code-btn" onclick="copyCode('code-gemini')">&#9112; Copy</button>`;
    }

    function saveOverrides() {
      try {
        const overrides = {
          baseUrl: document.getElementById('baseUrl').value,
          apiKey: document.getElementById('apiKey').value,
          model: document.getElementById('defaultModel').value,
        };
        localStorage.setItem('codex-proxy-config-overrides', JSON.stringify(overrides));
      } catch {}
    }

    function restoreOverrides() {
      try {
        const raw = localStorage.getItem('codex-proxy-config-overrides');
        if (!raw) return;
        const overrides = JSON.parse(raw);
        if (overrides.baseUrl) document.getElementById('baseUrl').value = overrides.baseUrl;
        if (overrides.apiKey) document.getElementById('apiKey').value = overrides.apiKey;
        if (overrides.model) {
          const sel = document.getElementById('defaultModel');
          // Only apply if the option exists in the dropdown
          const opts = Array.from(sel.options).map(o => o.value);
          if (opts.includes(overrides.model)) sel.value = overrides.model;
        }
      } catch {}
    }

    function resetConfigDefaults() {
      try { localStorage.removeItem('codex-proxy-config-overrides'); } catch {}
      document.getElementById('baseUrl').value = serverBaseUrl;
      document.getElementById('apiKey').value = serverApiKey;
      // Re-select preferred model
      const sel = document.getElementById('defaultModel');
      const preferred = Array.from(sel.options).find(o => o.value.includes('5.3-codex'));
      if (preferred) sel.value = preferred.value;
      else if (sel.options.length) sel.selectedIndex = 0;
      updateCodeExamples();
    }

    function setupReactiveBindings() {
      document.getElementById('baseUrl').addEventListener('input', () => { updateCodeExamples(); saveOverrides(); });
      document.getElementById('apiKey').addEventListener('input', () => { updateCodeExamples(); saveOverrides(); });
      document.getElementById('defaultModel').addEventListener('change', () => { updateCodeExamples(); saveOverrides(); });
    }

    function switchTab(tab, el) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('tab-' + tab).classList.add('active');
    }

    function copyField(id, btn) {
      const el = document.getElementById(id);
      const text = el.value !== undefined ? el.value : el.textContent;
      navigator.clipboard.writeText(text);
      btn.classList.add('copied');
      setTimeout(() => btn.classList.remove('copied'), 2000);
    }

    function copyCode(id) {
      const el = document.getElementById(id);
      // Get text content excluding the copy button
      const clone = el.cloneNode(true);
      const btns = clone.querySelectorAll('.copy-code-btn');
      btns.forEach(b => b.remove());
      const code = clone.textContent.trim();
      navigator.clipboard.writeText(code);
    }

    async function logout() {
      await fetch('/auth/logout', { method: 'POST' });
      window.location.href = '/';
    }

    let addPollTimer = null;

    async function startAddAccount() {
      const btn = document.getElementById('addAccountBtn');
      const infoEl = document.getElementById('addInfo');
      const errEl = document.getElementById('addError');
      infoEl.style.display = 'none';
      errEl.style.display = 'none';
      btn.disabled = true;
      btn.textContent = 'Opening...';

      try {
        const resp = await fetch('/auth/login-start', { method: 'POST' });
        const data = await resp.json();

        if (!resp.ok || !data.authUrl) {
          throw new Error(data.error || 'Failed to start login');
        }

        window.open(data.authUrl, 'oauth_add', 'width=600,height=700,scrollbars=yes');

        document.getElementById('addSection').classList.add('open');
        btn.textContent = '+ Add Account';
        btn.disabled = false;

        if (addPollTimer) clearInterval(addPollTimer);
        const prevCount = (await fetch('/auth/accounts').then(r => r.json())).accounts?.length || 0;
        addPollTimer = setInterval(async () => {
          try {
            const r = await fetch('/auth/accounts');
            const d = await r.json();
            if ((d.accounts?.length || 0) > prevCount) {
              clearInterval(addPollTimer);
              document.getElementById('addSection').classList.remove('open');
              infoEl.textContent = 'Account added successfully!';
              infoEl.style.display = 'block';
              await loadAccounts();
              await loadStatus();
            }
          } catch {}
        }, 2000);
        setTimeout(() => { if (addPollTimer) clearInterval(addPollTimer); }, 5 * 60 * 1000);

      } catch (err) {
        btn.textContent = '+ Add Account';
        btn.disabled = false;
        errEl.textContent = err.message;
        errEl.style.display = 'block';
      }
    }

    async function submitAddRelay() {
      const callbackUrl = document.getElementById('addCallbackInput').value.trim();
      const infoEl = document.getElementById('addInfo');
      const errEl = document.getElementById('addError');
      infoEl.style.display = 'none';
      errEl.style.display = 'none';

      if (!callbackUrl) {
        errEl.textContent = 'Please paste the callback URL';
        errEl.style.display = 'block';
        return;
      }

      const btn = document.getElementById('addRelayBtn');
      btn.disabled = true;
      btn.textContent = 'Submitting...';

      try {
        const resp = await fetch('/auth/code-relay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ callbackUrl }),
        });
        const data = await resp.json();

        if (resp.ok && data.success) {
          if (addPollTimer) clearInterval(addPollTimer);
          document.getElementById('addSection').classList.remove('open');
          document.getElementById('addCallbackInput').value = '';
          infoEl.textContent = 'Account added successfully!';
          infoEl.style.display = 'block';
          await loadAccounts();
          await loadStatus();
        } else {
          errEl.textContent = data.error || 'Failed to exchange code';
          errEl.style.display = 'block';
        }
      } catch (err) {
        errEl.textContent = 'Network error: ' + err.message;
        errEl.style.display = 'block';
      } finally {
        btn.textContent = 'Submit';
        btn.disabled = false;
      }
    }

    loadStatus();
    setupReactiveBindings();
    loadAccounts();
  </script>
</body>
</html>
